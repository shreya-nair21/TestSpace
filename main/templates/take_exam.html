{% extends 'base.html' %}
{% block content %}

<h2>{{ exam.title }}</h2>

<!-- Old timer removed, using fixed widget -->

<div id="exam-timer" class="card shadow-sm border-warning"
    style="position: absolute; top: 95px; right: 115px; z-index: 100; width: 100px; background-color: rgba(255, 255, 255, 0.9);">
    <div class="card-body p-2 text-center">
        <h6 class="card-title m-0 text-muted" style="font-size: 0.8rem;">Time Left</h6>
        <h4 class="card-text text-danger m-0" id="fixed-timer" data-duration="{{ duration_seconds|default:0 }}"></h4>
    </div>
</div>

<form id="examForm" method="POST" action="{% url 'take_exam' exam.id %}">
    {% csrf_token %}

    <!-- Hidden input to store time taken (filled by JS) -->
    <input type="hidden" name="time_taken" id="time_taken">

    {% for q in questions %}
    <div class="mb-4">
        <strong>{{ forloop.counter }}. {{ q.text }}</strong>

        {% for opt in q.option_set.all %}
        <div class="form-check">
            <input type="radio" name="{{ q.id }}" value="{{ opt.id }}" class="form-check-input">
            <label class="form-check-label">{{ opt.text }}</label>
        </div>
        {% endfor %}
    </div>

    <hr>
    {% endfor %}

    <button type="submit" class="btn btn-success">Submit</button>
</form>

<script>
    // Timer in seconds (passed from Django)
    let fixedTimer = document.getElementById('fixed-timer');
    // Default to 0 if not found or parsing fails
    let timeLeft = fixedTimer ? (parseInt(fixedTimer.dataset.duration, 10) || 0) : 0;
    let totalTime = timeLeft;

    function updateTimer() {
        if (!fixedTimer) return;

        let minutes = Math.floor(timeLeft / 60);
        let seconds = timeLeft % 60;
        let formattedTime = `${minutes}:${seconds.toString().padStart(2, '0')}`;

        fixedTimer.textContent = formattedTime;

        if (timeLeft <= 0) {
            document.getElementById("examForm").submit();   // Auto-submit
        } else {
            timeLeft--;
            setTimeout(updateTimer, 1000);
        }
    }

    // Fill time_taken before submitting manually
    let form = document.getElementById('examForm');
    if (form) {
        form.addEventListener('submit', function () {
            document.getElementById('time_taken').value = totalTime - timeLeft;
        });
    }

    if (fixedTimer && timeLeft > 0) {
        updateTimer();
    }
</script>

{% endblock %}